# Plan: Generalized Lukio Lesson Plan Pipeline

## In / Out

**In:** Gemini Deep Research document (markdown) for any Finnish lukio subject
**Out:** Per-topic one-pager lesson plans (75 min) as markdown files

## Pipeline

```
research_doc.md + basic params
        │
        ▼
┌──────────────────────────────────────────────┐
│  bootstrap.yaml  (NEW)                       │
│  research_doc → 4 prompt files + vars.yaml   │
│  Single LLM call, writes to project_dir/     │
└──────────────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────────┐
│  prepare.yaml  (EXISTING, parameterized)     │
│  research_doc → topics + vuosikello          │
│  → websearch augmentation per topic          │
│  → JSON files in output/{module}/            │
└──────────────────────────────────────────────┘
        │
        ▼
┌──────────────────────────────────────────────┐
│  generate.yaml  (EXISTING, parameterized)    │
│  JSON → fan-out 1 LLM call per topic         │
│  → output/{module}/lessons/*.md              │
└──────────────────────────────────────────────┘
```

## What changes

### 1. Fix hardcoded paths in Python nodes

Three files have `Path("projects/opinto_ohjaus/output")`. Change to use
`state.get("project_dir", ".")`:

| File | Line | Change |
|------|------|--------|
| `nodes/load_data.py` | 39 | `Path(state.get("project_dir", ".")) / "output" / module` |
| `nodes/save_preparation.py` | 61 | `Path(state.get("project_dir", ".")) / "output" / module` |
| `nodes/save_lessons.py` | 70 | `Path(state.get("project_dir", ".")) / "output" / module / "lessons"` |

Add `project_dir: str` to `state:` in `prepare.yaml` and `generate.yaml`.
Add `project_dir: projects/opinto_ohjaus` to `vars.yaml`.

### 2. Add bootstrap.yaml

New graph: 2 nodes (bootstrap LLM + save_bootstrap python).

- **Input**: `research_doc`, `project_dir`, `school_context`, `hours_per_module`, `lesson_duration`
- **Output**: `{project_dir}/vars.yaml` + `{project_dir}/prompts/*.yaml` (4 files)

The bootstrap prompt includes the 4 opinto-ohjaus prompts as structural
examples. The LLM adapts domain content while preserving template structure.

### 3. Add nodes/save_bootstrap.py

Writes LLM-generated vars.yaml and 4 prompt files to `project_dir/`.
Validates YAML syntax before writing. The generated `vars.yaml` must
include `project_dir` so that prepare/generate pick it up via `--var-file`.

### 4. Add prompts/bootstrap.yaml

The meta-prompt. Includes:
- Role: lukio curriculum expert + pipeline configurator
- Analysis checklist: subject, modules, assessment, sources, methods
- 4 opinto-ohjaus prompts as format examples (verbatim)
- Instructions to produce same structure with new domain content

### 5. Tests

- Bootstrap graph lints and loads
- Existing 12 tests still pass (nodes default `project_dir` to `.`)
- `yamlgraph graph lint` on generated prompts

## Shared-graph pattern

Graphs (`bootstrap.yaml`, `prepare.yaml`, `generate.yaml`) and Python nodes
(`nodes/*.py`) live in `projects/opinto_ohjaus/` and are shared across all
subjects. A new subject gets only:

```
projects/terveystieto/
├── terveystieto-ops.md       # research doc (input)
├── vars.yaml                 # generated by bootstrap
├── prompts/*.yaml            # generated by bootstrap
└── output/{module}/lessons/  # generated by pipeline
```

The `--var-file` points to the new subject's vars, but the graph path
always points to `projects/opinto_ohjaus/`.

## Usage for a new subject

```bash
# 1. Gemini Deep Research
# Query: "terveystieto, lukion opetussuunnitelma LOPS 2019"
# Save as: projects/terveystieto/terveystieto-ops.md

# 2. Bootstrap
mkdir -p projects/terveystieto
yamlgraph graph run projects/opinto_ohjaus/bootstrap.yaml \
  --var research_doc=@projects/terveystieto/terveystieto-ops.md \
  --var project_dir=projects/terveystieto \
  --var school_context="Keskikokoinen lukio, noin 300 opiskelijaa" \
  --var hours_per_module=18 \
  --var lesson_duration=75

# 3. Prepare
yamlgraph graph run projects/opinto_ohjaus/prepare.yaml \
  --var-file projects/terveystieto/vars.yaml \
  --var research_doc=@projects/terveystieto/terveystieto-ops.md

# 4. Generate
PROVIDER=anthropic yamlgraph graph run projects/opinto_ohjaus/generate.yaml \
  --var-file projects/terveystieto/vars.yaml

# 5. Review
cat projects/terveystieto/output/TE1/lessons/index.md
```


